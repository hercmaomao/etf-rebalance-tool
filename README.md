# ETF 调仓辅助助手 (ETF Rebalancing Assistant)

这是一个基于 Streamlit 开发的 ETF 持仓偏离分析与调仓辅助工具。它能够读取用户的持仓 Excel 文件，对比预设的目标权重，自动计算偏离度并判断是否需要调仓。

## 🚀 功能特性

*   **自动化分析**：上传 Excel 即可自动计算各账户的持仓权重。
*   **多维度规则判定**：
    *   **总偏离率 (盈米规则)**：计算组合整体的偏离程度 (`Sum(|实际 - 目标|) / 2`)。
    *   **组合预警 (轻舟规则)**：针对特定资产组合（如 VTI+SPY 美股组合、MCHI+ASHR 中国资产组合）进行重点监测，当组合偏离度超过 2% 时触发“🚨 需调仓”警报。
*   **灵活配置**：通过 `config.json` 文件自定义目标权重、Excel 列名映射及预警阈值。
*   **可视化报表**：清晰展示实际占比与目标占比的差值，支持高亮预警行，并在表格顶部置顶“目标持仓标准”作为参考。
*   **数据导出**：支持将分析结果导出为 CSV 文件。

## 🛠️ 安装与运行

### 1. 环境准备
确保已安装 Python (建议 3.8+)。

### 2. 安装依赖
在项目根目录下运行：
```bash
pip install -r requirements.txt
```

### 3. 启动应用
```bash
streamlit run app.py
```
启动后，浏览器将自动打开应用页面（默认为 `http://localhost:8501`）。

## 📂 数据准备与配置

### 输入文件格式
请准备包含持仓数据的 Excel 文件 (`.xlsx` 或 `.xls`)。文件需包含以下列（列名可在 `config.json` 中修改）：
*   **账号标识** (默认列名: `盈立号`)：用于区分不同账户，支持多账户批量分析。
*   **证券代码** (默认列名: `证券代码`)：如 SPY, VTI 等（不区分大小写）。
*   **证券市值** (默认列名: `证券市值`)：用于计算权重。

### 配置文件 (config.json)
项目根目录下的 `config.json` 控制核心逻辑：

*   `target_weights`: 定义各 ETF 的目标持仓百分比 (例如 `"SPY": 0.09`)。
*   `columns`: 定义 Excel 文件中对应的列名映射。
*   `app_settings`:
    *   `drift_divisor`: 计算总偏离率的除数 (默认 2.0)。
*   `status_labels`: 自定义状态显示的文本 (如 "🚨 需调仓", "✅ 正常")。

## 📊 算法逻辑说明

1.  **数据清洗**：自动去除代码空格并转为大写。
2.  **权重计算**：`单只 ETF 权重 = 该 ETF 市值 / 账户总市值`。
3.  **偏离度展示**：显示格式为 `实际占比 (实际 - 目标)`。正数代表超配，负数代表欠配。
4.  **预警逻辑 (轻舟规则)**：
    *   计算 **VTI + SPY** 的实际总权重与目标总权重，若偏差绝对值 > 2%。
    *   计算 **MCHI + ASHR** 的实际总权重与目标总权重，若偏差绝对值 > 2%。
    *   若任一条件满足，状态标记为 **Warning**。

## 📝 目录结构

```text
.
├── app.py              # 主应用程序代码
├── config.json         # 配置文件 (目标权重、列名映射)
├── requirements.txt    # 项目依赖库
└── README.md           # 说明文档
```

## ⚠️ 注意事项

*   请确保 `config.json` 文件始终位于项目根目录下，否则程序无法启动。
*   Excel 文件中若缺少必要列，程序会报错提示。